<!DOCTYPE html>
<html lang='en'>
	<head>
    <script type='text/javascript' src='https://miro.com/app/static/sdk.1.1.js'></script>
    <script type='text/javascript'>

			const APP_ID = '3074457346924511910';

			const placeholderIcon = '<circle cx="12" cy="12" r="9" fill="none" fill-rule="evenodd" stroke="currentColor" stroke-width="2"/>';

			const MIRO_RECTANGLE_SHAPE_TYPE = 3;
			const MIRO_YELLOW_COLOR = '#fef445';
			const MIRO_BLACK_COLOR =  '#000000';

			function metadata(status) {
				const metadata = {};
				metadata[APP_ID] = {status);
				return metadata;
			}

			async function createTodo() {
				const viewport = await miro.board.viewport.getViewport();
				const x = viewport.x + (viewport.width / 2);
				const y = viewport.y + (viewport.height / 2);

				const todos = await miro.board.widgets.create({
					'text': 'TODO',
					'type': 'shape',
					'style': {
						'shapeType': MIRO_RECTANGLE_SHAPE_TYPE,
						'backgroundColor': MIRO_YELLOW_COLOR,
						'backgroundOpacity': 0.4,
						'borderColor': 'transparent',
						'borderWidth': 0,
						'textColor': MIRO_BLACK_COLOR,
						'highlighting': '',
					},
					x,
					y,
					metadata: metadata('unstarted'),
				});
			}

			function finishTodo(widget) {
				console.log('clicked TODO', widget); // DELETE ME
				const todos = await miro.board.widgets.update(w, {
					metadata: metadata('unstarted'),
				});
				console.log('updated TODOs', todos); // DELETE ME
			}

			async function onCanvasClicked(e) {
				const widgets = await miro.board.widgets.__getIntersectedObjects(e.data);
				const todos = widgets.filter(w => w.metadata[APP_ID]);

				if (todos.length > 1) {
					console.warn('Overlapping TODOs not supporting. Completing only one.');
				}

				if (todos.length > 0) {
					finishTodo(todos[0]);
				}
			}

			miro.onReady(() => {

				miro.initialize({
					extensionPoints: {
						toolbar: {
							title: 'TODO',
							toolbarSvgIcon: placeholderIcon,
							librarySvgIcon: placeholderIcon,
							onClick: createTodo,
						},
					}
				});

				miro.addListener('CANVAS_CLICKED', onCanvasClicked);

			});

    </script>
	</head>
</html>

